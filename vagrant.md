# Barsup Demo

## Работа с компонентами проекта

Для большего удобства **настоятельно рекомендуется** работа с проектом в среде Vagrant-контейнера.

## Vagrant

Для запуска проекта внутри Vagrant-контейнера нужно совершить следующие действия:

1. Установить [VirtualBox](https://www.virtualbox.org/)
1. Установить [Vagrant](https://www.vagrantup.com/)
1. Склонировать репозиторий проекта
1. При необходимости настроить Vagrant для работы через прокси-сервер (см.ниже)
1. Из папки проекта инициализировать контейнер командой ```vagrant up```
1. Перейти в браузере на страницу [http://localhost:8000/](http://localhost:8000/)

Порт с номером 8000 из виртуального образа, по-умолчанию мапится с аналогичный порт,
поэтому этот порт не должен быть занят.

### Работа с контейнером

**Примечание:** работа с контейнером производится из корневой папки
репозитория проекта, т.е. перед вводом команд нужно перейти в
соответствующую директорию.

Инициализируется контейнер следующим образом:

    vagrant up

После того как контейнер успешно проинициализировался, подключиться к нему можно так:

    vagrant ssh

**Важно:** при выходе из ssh-сессии виртуальная машина, в которой запускается контейнер,
не останавливается. Т.о. к ней можно подключаться неограниченное число раз,
в т.ч. и единовременно.

Остановка контейнера производится следующим образом:

    vagrant suspend

При этом виртуальная машина приостановится с сохранением своего текущего состояния
и в последствии может быть вновь запущена командой ```vagrant up```.

В любой момент созданную машину можно откатить в исходное состояние командой:

    vagrant destroy

Сама ВМ откатится в исходное состояние, но файлы проекта при этом останутся нетронутыми,
из чего следует, что данный механизм не предназначен для отката изменений файлов проекта!

Папка с проектом монтируется в ВМ по пути ```/vagrant``` и все изменения содержимого этой папки
как изнутри контейнера, так и вне его перманентны и видны сразу, причем как в контейнере,
так и на хостовой машине.

### Запуск Web-server-а и worker-а:

Web-сервер запускается командой

    bup_start server [config]

Worker же запускается командой

    bup_start worker [config]

Если путь до файла конфигурации задачи (```config```) опустить,
то файлы конфигурации будут предполагать именование вида ```<задача>.json```,
а искаться будет сначала в ```$BUP_PATH```, а затем в текущей папке.
В контейнере умолчательно прописан ```BUP_PATH=/vagrant/src/barsup_demo```,
т.о. задачи можно запускать не указывая конкретные конфигурации.


### Натройка Vagrant для работы через proxy-сервер

Для удобной работы с прокси-серверами нужно установить соответствующий плагин:

    vagrant plugin install vagrant-proxyconf

Затем в файле ```$HOME/.vagrant.d/Vagrantfile``` указать настройки прокси-сервера:

    Vagrant.configure("2") do |config|
      if Vagrant.has_plugin?("vagrant-proxyconf")
        config.proxy.http     = "http://192.168.0.2:3128/"
        config.proxy.https    = "http://192.168.0.2:3128/"
        config.proxy.no_proxy = "localhost,127.0.0.1,.example.com"
      end
      # ... other stuff
    end

