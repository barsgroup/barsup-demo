# Demo

Демо представляет собой проект с декларативном описанием набора сущностей вида:
* Авторы, Книги, Пользователи, Выданные книги;
* Физ. лица и их автомобили.

## Описание конфигурационных файлов 

В корне проекта находятся три файла:
* mapping.json - описание структуры хранения в базе данных;
* worker.json - описание уровней контроллеров, сервисов и моделей со связями между собой;
* server.json - описание файла конфигурации проекта.

### mapping.json
Описывает в json отображение таблиц и полей в базу данных. Пример представления M2M связи - авторов, книг и связи между ними:

    [{
        # Описание таблицы Авторов  - author
        "__name__": "author",  # Название таблицы
        "__columns__": [  # Перечисление колонок в таблице
            {
                "__name__": "id",  # Название поля - id
                "__type__": { "__name__": "$Integer"}, # Наименование типа - Integer
                "primary_key": true  # Признак первичного ключа в тцблице
            },
            {
                "__name__": "fname",
                "__type__": {"__name__": "$String", "length": 50},  # Наименование типа - String  с максимальной длиной поля 50
                "nullable": false  # Признак того, что поле не может быть NULL
            },
            {
                "__name__": "lname",
                "__type__": {"__name__": "$String", "length": 50},
                "nullable": false
            }
        ]
    },
    {
        # Описание таблицы книг
        "__name__": "book",
        "__columns__": [
            {
                "__name__": "id",
                "__type__": {"__name__": "$Integer"},
                "primary_key": true
            },
            {
                "__name__": "name",
                "__type__": {"__name__": "$String", "length": 50},
                "nullable": false
            },
            {
                "__name__": "year",
                "__type__": {"__name__": "$Integer"},
                "nullable": false
            }
        ]
    },
    {
        # Описание связующей таблицы со связями авторов и книг
        "__name__": "author_book",
        "__columns__": [
            {
                "__name__": "id",
                "__type__": {"__name__": "$Integer"},
                "primary_key": true
            },
            {
                "__name__": "author_id",
                "__type__": {"__name__": "$Integer"},
                "__fk__": {"__name__": "$ForeignKey", "column": "author.id"},  # Поле является внешним ключом к  полю id из таблицы author
                "nullable": false
            },
            {
                "__name__": "book_id",
                "__type__": {"__name__": "$Integer"},
                "__fk__": {"__name__": "$ForeignKey", "column": "book.id"},
                "nullable": false
            }
        ]
    }]
    
Поля в файле, которые начинаются с двух нижних подчеркиваний и заканчиваются двумя нижними подчеркиваниями (например, \_\_name\_\_) являются идентификаторами скелета файла. Они преобразовываются (не маппятся напрямую) в констуркции SqlAlchemy ORM.

Остальные поля с их значениями маппятся в таком же виде в конструкции SqlAlchemy ORM.

Значения полей, начинающихся с "$" представляют собой идентификаторы типов объектов, например:
* $Integer - определяет тип поля Integer
* $ForeignKey - определяет внешний ключ для поля

Все доступные типы значений можно посмотреть [здесь](http://docs.sqlalchemy.org/en/latest/core/types.html).
    
Файл mapping.json не может содержать внутри себя комментарии, так как в таком случае будет **невалидным**.


## worker.json
Файл представляет собой описание контейнера связи уровней приложения.
Контейнер может содержать декларативное описание любых уровней. В данный момент в демо выделены уровни:
* *Контроллеров (Controllers)* - Уровень для валидации значений, для работы с транзакциями и преобразованиями данных в пользовательское представление, серриализация данных в json/xml/etc. представления
* *Сервисов (Services)* - Уровень для работы с бизнес-логикой приложения, работа с сессией соединения к бд, операции с моделями
* *Сесии (Session)* - Уровень, отвечающий за работу DML на уровне БД. Непосредственное извлечение и изменение объектов в БД
* *Моделей (Models)* - Тонкий уровень отображения таблиц. Наименования модели однозначно должны быть связаны с наименованиями таблиц из файла mapping.json

Пример конфиугации для сущностей авторов - книг и связей между ними:

    {
        "container": {
            "controller": {  # Описание уровня контроллеров
                # Каждый уровень может иметь умолчательную реализацию, определяемую ниже
                # Конткретный контроллер может переопределить реализацию переопределив внутри своего тела __realization__
                "__default__": {"__realization__": "barsup.controller.DictController"},

                "Author": {"service": "AuthorService"}, # Описание контроллера Author с зависимостью от сервиса AuthorService
                "Book": {"service": "BookService"},
                "AuthorBook": {"service": "AuthorBookService"}
            },
            "session": {  # Описание уровня сессий
                "default": {"__realization__": "barsup.session.DefaultSession"}
            },
            "service": {  # Описание уровня сервисов
                "__default__": {
                    "__realization__": "barsup.service.Service",
                    "session": "default",  # Определение умолчательной зависимости от уровня сессии
                    "db_mapper": "default",  # Определение маппера, для доступа к моделям
                    "$joins": []  # Определение связей с другими моделями
                },
                "BookService": {"model": "book"},  # Описание сервиса BookService c указанием зависимости от модели book
                "AuthorService": {"model": "author"},
                "AuthorBookService": {"model": "author_book"}
            },
            "model": {  # Описание уровня моделей
                "__default__": {
                    "__realization__": "barsup.mapping.get_model",
                    "db_mapper": "default"  # Определение маппера для поиска модели
                },
                "author": {"$name": "author"},  # Описание модели и связи с одноименной таблицей
                "book": {"$name": "book"},
                "author_book": {"$name": "author_book"}
            },
            "db_mapper": {  # Вспомогательный механизм, необходимый для маппинга моделей с одноименными таблицами, описываемыми в файле mapping.json
                "default": {
                    "__realization__": "barsup.mapping.DBMapper",
                    "__type__": "singleton"  # Экземпляр создается однажды
                }
            }
        }
    }

Значения, начинающиеся с "$" не будут искаться в контейнере, они подставляются напрямую в параметры реализации. По иным значениям будет производится поиск реализации в контейнере.

Возможные значения поля \_\_type\_\_:
* **singleton** - будет создан экземпляр однажды, далее где необходимо будет использоваться этот экземпляр
* **static** - может представлять из себя функции, константы, типы данных, которые как есть будут использоваться в качестве реализации. Параметры внутрь передаваться не будут.
* **не определено** - фабричное поведение. Экзмпляр будет создаваться каждый раз, зависимые параметры будут переданы в конструктор.

### server.json
Файл содержим настройки запуска сервера.